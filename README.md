# FlightControls Launcher

## 项目概括
本项目旨在开发一个基于Qt 5.12.8的Linux桌面应用程序，用于集成和管理QGroundControl和RVIZ两个飞行控制相关的应用程序。通过X11窗口嵌入技术和预启动机制，实现无缝的应用程序切换体验。

## 技术
- 主要编程语言: C++ (Qt 5.12.8)
- 关键库/框架: 
  - Qt Core, Qt Widgets, Qt GUI
  - X11 libraries (libX11, libXext)
  - QMake (构建系统)
- 目标平台: Ubuntu 18.04 LTS
- 编译器: GCC
- 外部依赖: 
  - QGroundControl.AppImage
  - ROS (Robot Operating System) 
  - RVIZ package
- 版本控制: Git


## 技术实现细节

### QMake项目结构 
- **配置**: 使用CMake 3.10+，设置C++17标准
- **Qt集成**: 配置Qt 5.12.8，启用MOC、UIC、RCC自动处理
- **X11支持**: 集成X11和X11扩展库，用于窗口嵌入功能
- **目录结构**: 自动创建src/

### 主窗口UI布局 
- **整体布局**: 采用QVBoxLayout垂直布局，分为工具栏区域和内容区域
- **工具栏设计**: 固定高度60px，包含标题、切换按钮和状态标签
- **按钮样式**: QGC和RVIZ按钮支持切换状态，带悬停和按下效果
- **内容区域**: 使用QStackedLayout管理两个页面，每页包含独立的嵌入容器
- **响应式设计**: 支持窗口大小调整，容器自动适应


### MainWindow基础框架 
- **类结构**: 继承自QMainWindow，采用信号槽机制管理用户交互
- **模块集成**: 集成ProcessManager、WindowEmbedder、ApplicationSwitcher三个核心模块
- **状态管理**: 维护应用程序运行状态、嵌入状态和当前活动应用
- **事件处理**: 处理窗口关闭、大小调整等系统事件
- **UI初始化**: 自动设置窗口属性、居中显示、状态栏配置
- **按钮组管理**: 实现QGC和RVIZ按钮的互斥选择行为

### ProcessManager-QGC管理 
- **进程管理架构**: 使用QProcess管理外部应用程序生命周期，支持启动、停止、重启操作
- **QGroundControl集成**: 自动查找QGroundControl.AppImage文件，支持多个常见位置搜索
- **进程监控**: 实现进程状态监控、自动重启机制和崩溃恢复
- **信号通信**: 通过Qt信号槽机制与MainWindow通信，实时更新进程状态
- **错误处理**: 完善的错误检测和用户友好的错误消息反馈
- **环境检查**: 系统依赖检查，包括X11环境和可执行文件验证
- **资源管理**: 优雅的进程终止和资源清理机制
- **RVIZ预留**: 为RVIZ进程管理预留接口和占位符实现

### ProcessManager-RVIZ管理 
- **双进程架构**: 管理roscore和rviz两个独立进程，实现正确的启动顺序和依赖关系
- **ROS环境集成**: 检查ROS_DISTRO环境变量，验证roscore和rviz命令可用性
- **启动序列控制**: 先启动roscore，等待其准备就绪后再启动rviz进程
- **就绪状态检测**: 使用rostopic list命令检测roscore是否完全启动
- **定时检查机制**: 实现30秒超时的roscore就绪检查，防止无限等待
- **进程依赖管理**: roscore停止时自动停止rviz，确保进程组的一致性
- **环境变量配置**: 正确设置ROS_MASTER_URI等环境变量确保进程间通信
- **错误处理**: 针对roscore和rviz分别实现错误检测和自动重启机制

### WindowEmbedder-窗口查找 
- **X11集成**: 使用X11 API建立与显示服务器的连接，获取根窗口和屏幕信息
- **窗口遍历**: 实现递归窗口树遍历，获取系统中所有窗口的完整列表
- **多维度查找**: 支持通过进程ID、窗口标题、类名等多种方式查找目标窗口
- **智能匹配**: 针对QGroundControl和RVIZ实现专门的窗口识别算法
- **窗口属性获取**: 获取窗口标题、类名、进程ID、几何信息等详细属性
- **窗口过滤**: 识别主窗口和应用程序窗口，过滤系统窗口和工具窗口
- **状态检测**: 检查窗口的可见性、映射状态和有效性
- **定时监控**: 实现窗口搜索和状态监控的定时器机制
- **错误处理**: 完善的X11错误处理和资源清理机制

### WindowEmbedder-窗口嵌入 
- **核心嵌入技术**: 使用XReparentWindow实现外部窗口到Qt容器的嵌入
- **窗口生命周期管理**: 完整的嵌入、取消嵌入和状态跟踪机制
- **大小同步**: 自动调整嵌入窗口大小以适应容器，支持动态大小变化
- **可见性控制**: 通过XMapWindow/XUnmapWindow控制嵌入窗口的显示隐藏
- **焦点管理**: 正确设置窗口焦点，确保键盘鼠标事件正常处理
- **属性设置**: 通过override_redirect禁用窗口管理器控制，确保嵌入稳定性
- **嵌入验证**: 通过XQueryTree验证嵌入操作的成功性
- **实时监控**: 定时检查嵌入窗口状态和大小同步
- **容器集成**: 支持Qt容器大小变化时自动调整嵌入窗口

### ApplicationSwitcher切换逻辑 
- **模块协调**: 作为系统的协调器，统一管理ProcessManager和WindowEmbedder
- **状态机管理**: 实现完整的切换状态机（空闲、切换中、等待应用、错误）
- **智能切换**: 检查应用程序准备状态，支持预启动和按需启动
- **超时机制**: 30秒切换超时保护，防止系统假死
- **容器管理**: 管理QGC和RVIZ容器的显示隐藏和大小同步
- **信号集成**: 完整集成所有模块信号，实现状态同步和错误处理
- **动画效果**: 支持淡入淡出切换动画，提升用户体验
- **错误恢复**: 自动处理应用程序崩溃和窗口丢失，支持自动重启
- **预加载机制**: 启动时预加载所有应用程序，实现零延迟切换

### 预启动机制集成 
- **智能预加载**: 启动时自动启动所有应用程序，实现零延迟切换体验
- **进度跟踪**: 实时显示预加载进度（0-100%），提供直观的启动反馈
- **后台管理**: 预加载的非当前应用程序在后台运行，窗口自动隐藏
- **状态管理**: 完整的预加载状态机（进行中、已完成、超时处理）
- **超时保护**: 60秒预加载超时机制，防止启动过程假死
- **延迟切换**: 预加载期间的切换请求会延迟到加载完成后执行
- **即时切换**: 预加载完成后，应用程序间切换实现毫秒级响应
- **错误容错**: 预加载失败时不影响手动切换，保证系统可用性
- **用户反馈**: 通过状态栏和消息框提供预加载进度和完成通知

### 错误处理和进程监控 
- **健康检查机制**: 10秒间隔的进程健康状态检查，实时监控应用程序运行状态
- **智能重启策略**: 基于退出码和崩溃次数的智能重启决策，防止无限重启循环
- **崩溃处理**: 完善的进程崩溃检测和恢复机制，自动分析崩溃原因
- **资源监控**: 实时监控进程资源使用情况，检测进程响应性
- **诊断系统**: 完整的系统诊断信息收集，支持故障排查和性能分析
- **日志管理**: 结构化的状态日志记录，包含时间戳和详细信息
- **僵尸进程清理**: 自动检测和清理无效进程，保持系统清洁
- **错误信号集成**: 完整的错误信号传播，UI实时反映系统状态
- **强制终止机制**: 安全的进程强制终止功能，避免资源泄漏
- **可执行文件验证**: 启动前验证应用程序可执行性和环境依赖

### UI状态管理 
- **智能状态同步**: 500ms间隔的UI状态更新，确保界面与系统状态完全同步
- **动态UI控制**: 根据系统状态自动启用/禁用按钮和菜单项，防止无效操作
- **视觉状态反馈**: 通过颜色、样式和文本变化实时反映应用程序状态
- **工具提示系统**: 为所有UI元素提供详细的帮助信息和快捷键提示
- **窗口管理优化**: 智能窗口居中、大小限制和响应式布局调整
- **状态栏增强**: 多维度状态信息显示，包括进程状态和系统状态
- **用户体验优化**: 流畅的状态过渡和直观的操作反馈

3. **应用程序切换**: 
   - 点击工具栏的 "QGroundControl" 或 "RVIZ" 按钮
   - 使用快捷键 `Ctrl+1` (QGroundControl) 或 `Ctrl+2` (RVIZ)
   - 使用菜单栏的相应选项


### 应用程序配置

#### QGroundControl设置
- 将QGroundControl.AppImage文件放置在项目目录或系统路径中
- 确保AppImage文件具有执行权限: `chmod +x QGroundControl.AppImage`


3. **QGroundControl无法启动**
   ```bash
   # 检查AppImage文件
   ls -la *.AppImage
   
   # 手动测试启动
   ./QGroundControl.AppImage
   ```

4. **RVIZ无法启动**
   ```bash
   # 检查ROS环境
   roscore &
   rosrun rviz rviz
   ```


